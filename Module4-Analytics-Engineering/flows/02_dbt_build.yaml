id: 02_dbt_build
namespace: zoomcamp.module4

description: |
  Runs dbt deps, seed, and build with --target prod to create all models.
  Then runs the FHV staging model for Q6.

tasks:
  - id: dbt_build_prod
    type: io.kestra.plugin.scripts.shell.Script
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
      image: python:3.11-slim
      memory:
        memory: 4GB
    beforeCommands:
      - pip install dbt-duckdb
    commands:
      - |
        # Create the dbt profile
        mkdir -p ~/.dbt
        cat > ~/.dbt/profiles.yml << 'EOF'
        taxi_rides_ny:
          target: dev
          outputs:
            dev:
              type: duckdb
              path: taxi_rides_ny.duckdb
              schema: dev
              threads: 1
              extensions:
                - parquet
              settings:
                memory_limit: '2GB'
                preserve_insertion_order: false
            prod:
              type: duckdb
              path: taxi_rides_ny.duckdb
              schema: prod
              threads: 1
              extensions:
                - parquet
              settings:
                memory_limit: '2GB'
                preserve_insertion_order: false
        EOF

        cd taxi_rides_ny

        echo "=== dbt deps ==="
        dbt deps

        echo "=== dbt seed (prod) ==="
        dbt seed --target prod

        echo "=== dbt build (prod) ==="
        dbt build --target prod

        echo "=== dbt build complete ==="