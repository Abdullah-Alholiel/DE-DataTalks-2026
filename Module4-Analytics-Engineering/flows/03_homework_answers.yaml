id: 03_homework_answers
namespace: zoomcamp.module4

description: |
  Queries DuckDB to answer Module 4 homework questions 3-6.

tasks:
  - id: query_answers
    type: io.kestra.plugin.scripts.python.Script
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
      image: python:3.11-slim
    beforeCommands:
      - pip install duckdb
    script: |
      import duckdb

      con = duckdb.connect("taxi_rides_ny.duckdb", read_only=True)

      print("=" * 60)
      print("MODULE 4 HOMEWORK ANSWERS")
      print("=" * 60)

      # Q1 - Conceptual
      print("\n--- Q1: dbt Lineage and Execution ---")
      print("Answer: int_trips_unioned only")
      print("  dbt run --select <model> builds ONLY that model.")
      print("  No + prefix means no upstream/downstream deps are included.")

      # Q2 - Conceptual
      print("\n--- Q2: dbt Tests ---")
      print("Answer: dbt will fail the test, returning a non-zero exit code")
      print("  Value 6 is not in accepted_values [1,2,3,4,5].")

      # Q3 - Count records in fct_monthly_zone_revenue
      print("\n--- Q3: Count of records in fct_monthly_zone_revenue ---")
      q3 = con.execute("SELECT COUNT(*) FROM prod.fct_monthly_zone_revenue").fetchone()[0]
      print(f"Answer: {q3:,}")

      # Q4 - Best performing zone for Green taxis 2020
      print("\n--- Q4: Best performing zone for Green taxis (2020) ---")
      q4 = con.execute("""
          SELECT pickup_zone, SUM(revenue_monthly_total_amount) as total_revenue
          FROM prod.fct_monthly_zone_revenue
          WHERE service_type = 'Green'
            AND revenue_month >= '2020-01-01'
            AND revenue_month < '2021-01-01'
          GROUP BY pickup_zone
          ORDER BY total_revenue DESC
          LIMIT 5
      """).fetchall()
      for row in q4:
          print(f"  {row[0]}: ${row[1]:,.2f}")
      print(f"Answer: {q4[0][0]}")

      # Q5 - Green taxi trips October 2019
      print("\n--- Q5: Green taxi trip counts (October 2019) ---")
      q5 = con.execute("""
          SELECT SUM(total_monthly_trips) as total_trips
          FROM prod.fct_monthly_zone_revenue
          WHERE service_type = 'Green'
            AND revenue_month = '2019-10-01'
      """).fetchone()[0]
      print(f"Answer: {q5:,}")

      # Q6 - Count records in stg_fhv_tripdata
      print("\n--- Q6: Count of records in stg_fhv_tripdata ---")
      try:
          q6 = con.execute("SELECT COUNT(*) FROM prod.stg_fhv_tripdata").fetchone()[0]
          print(f"Answer: {q6:,}")
      except Exception as e:
          print(f"ERROR: stg_fhv_tripdata not found in prod schema.")
          print(f"  Make sure you ran: dbt run --select stg_fhv_tripdata --target prod")
          print(f"  Error: {e}")

      con.close()